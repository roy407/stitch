## 映射表使用说明（SIFT 柱面拼接）

本工具是一个基于SIFT特征匹配的柱面全景图像拼接系统，能够自动对齐多幅图像并生成列扫描格式的映射表。系统通过计算图像间的几何变换关系，构建无缝的全景图，并输出适用于嵌入式设备等需要高效图像重映射场景的映射文件。本说明介绍如何基于 `mapping_table_generation.py` 生成多相机柱面拼接映射表（`hknumber.bin`），以及主要参数含义与常见检查点。

### 目录结构
- `mapping_table_generation.py`：主脚本，读取多路相机图并生成映射表。
- `image.png`：示意图。
- `panorama_sift_dp.jpg`：全景拼接预览。
- `hknumber.bin`：列扫描顺序的映射表输出。


### 输入准备
1. 将待拼接的多路相机图像放到任意可访问路径，命名可自定义，需顺时针或逆时针依次排列。
2. 在脚本顶部填写 `IMG_FILES` 列表（按拼接顺序）`FOCAL_LENGTH`（焦距）。默认 `2926.82`。

### 快速使用
在仓库根目录执行：
python scripts/mapping_table/mapping_table_generation.py
运行结束后，查看 `scripts/mapping_table/output_sift_mapping/`：
- `panorama_sift_dp.jpg`：检查拼接效果、缝合线位置。
- `hknumber.bin`：最终映射表。

### 关键流程概览
1. **柱面投影**：`build_inverse_cylindrical_maps` 与 `cylindrical_project_image` 将每路图像投影到柱面，减小视差。
2. **特征匹配**：`sift_match_and_translation` 使用 SIFT + BFMatcher + Ratio Test + RANSAC 获取相邻相机平移。
3. **画布计算与透视变换**：`compute_canvas_bounds` 与 `warp_all_images` 计算统一画布并将各图像投影上去。
4. **缝合线搜索**：`build_seam_info` 在重叠区寻找最小能量缝，减少接缝痕迹。
5. **映射表生成**：`generate_mapping_dict` 生成 `(cam_id, src_x, src_y) -> (out_x, out_y)` 映射；`save_column_major_map` 保存列扫描顺序的 `hknumber.bin`。
### 输出格式（`hknumber.bin`）
按列扫描顺序存储，每个像素对应三元组 `<cam_id, src_x, src_y>`，类型 `uint16`：
- 若像素无有效来源，`cam_id = 65535`（默认无效值）。
- 文件大小约为 `canvas_w * canvas_h * 6` 字节（3 个 `uint16`）。

### 校验要点
- 跑完后先检查 `panorama_sift_dp.jpg`：若出现大面积错位或空洞，优先调整：
  - `FOCAL_LENGTH`（影响柱面展开比例）。
  - `CROP_RATIO`（去除畸变边缘）。
  - `MATCH_SCALE` / `RATIO_TEST` / `MIN_INLIERS`（影响匹配质量）。



